/*! For license information please see yeim-uni-sdk.min.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var n in o)("object"==typeof exports?exports:e)[n]=o[n]}}(self,(()=>(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{YeIMUniSDK:()=>xt,YeIMUniSDKDefines:()=>o,instance:()=>Mt});var o={EVENT:{}};o.EVENT.NET_CHANGED="net_changed",o.EVENT.CONVERSATION_LIST_CHANGED="conversation_list_changed",o.EVENT.MESSAGE_RECEIVED="message_received",o.EVENT.MESSAGE_REVOKED="message_revoked",o.EVENT.PRIVATE_READ_RECEIPT="private_read_receipt",o.EVENT.KICKED_OUT="kicked_out",o.CONVERSATION_TYPE={},o.CONVERSATION_TYPE.PRIVATE="private",o.CONVERSATION_TYPE.GROUP="group",o.MESSAGE_TYPE={},o.MESSAGE_TYPE.TEXT="text",o.MESSAGE_TYPE.IMAGE="image",o.MESSAGE_TYPE.AUDIO="audio",o.MESSAGE_TYPE.VIDEO="video",o.MESSAGE_TYPE.LOCATION="location",o.MESSAGE_TYPE.CUSTOM="custom",o.MESSAGE_TYPE.GROUP_SYS_NOTICE="group_sys_notice",o.GROUP={},o.GROUP.JOINMODE={},o.GROUP.JOINMODE.FREE=1,o.GROUP.JOINMODE.CHECK=2,o.GROUP.JOINMODE.FORBIDDEN=3,o.GROUP.APPLYSTATUS={},o.GROUP.APPLYSTATUS.PENDING=1,o.GROUP.APPLYSTATUS.AGREE=2,o.GROUP.APPLYSTATUS.REFUSE=3;var n=200,s="接口调用成功",i=500,r="未知错误",a="YeIMUniSDK 初始化失败，请检查参数是否存在异常",c=10001,d="聊天服务网络连接错误",u=10002,l="用户验证失败，请检查userId、token",g=10003,f="用户登录状态过期，请重新登录",p=10004,h="未找到此会话",m=10008,y=10103,I="用户登录失败，请稍后再试",v=10251,T="此用户已在当前群组，请勿重复加入",P=10252,S="申请入群异常，请稍后重试",E=10253,b="已发送入群申请，请等待审核",k=10300,_="本地上传失败，请检查配置",U=10301,A=10302,C="腾讯云COS上传文件失败，请检查配置是否填写正确",O=10303,L="腾讯云媒体截图接口：下载视频缩略图失败，请检查网络或开启万象功能",N=10304,M="阿里云OSS上传文件失败，请检查配置是否填写正确";function x(e,t=null){return{code:200,message:e,data:t}}function G(e=500,t,o=null){return{code:e,message:t,data:o}}function R(e,t,o=null){try{null!=e&&void 0!==e.success&&"function"==typeof e.success&&e.success(x(t,o))}catch(e){console.error(e)}}function w(e,t=500,o,n=null){try{null!=e&&void 0!==e.fail&&"function"==typeof e.fail&&e.fail(G(t,o,n))}catch(e){console.error(e)}}function D(e,t){uni.$emit(Mt.defaults.eventPrefix+e,t)}function H(e,t){e&&uni.$on(Mt.defaults.eventPrefix+e,t)}function V(e,t){e&&uni.$off(Mt.defaults.eventPrefix+e,t)}const Y=function(e,t,o=!1){if(0==Mt.defaults.logLevel)o?console.error("【YeIMUniSDK Log】",t):console.log("【YeIMUniSDK Log】",t);else{if(2==Mt.defaults.logLevel)return;1==e&&(o?console.error("【YeIMUniSDK Log】",t):console.log("【YeIMUniSDK Log】",t))}};var B=function(e,t){return e<<t|e>>>32-t},$=function(e,t){var o,n,s,i,r;return s=2147483648&e,i=2147483648&t,r=(1073741823&e)+(1073741823&t),(o=1073741824&e)&(n=1073741824&t)?2147483648^r^s^i:o|n?1073741824&r?3221225472^r^s^i:1073741824^r^s^i:r^s^i},K=function(e,t,o,n,s,i,r){return e=$(e,$($(function(e,t,o){return e&t|~e&o}(t,o,n),s),r)),$(B(e,i),t)},F=function(e,t,o,n,s,i,r){return e=$(e,$($(function(e,t,o){return e&o|t&~o}(t,o,n),s),r)),$(B(e,i),t)},j=function(e,t,o,n,s,i,r){return e=$(e,$($(function(e,t,o){return e^t^o}(t,o,n),s),r)),$(B(e,i),t)},q=function(e,t,o,n,s,i,r){return e=$(e,$($(function(e,t,o){return t^(e|~o)}(t,o,n),s),r)),$(B(e,i),t)},z=function(e){var t,o="",n="";for(t=0;t<=3;t++)o+=(n="0"+(e>>>8*t&255).toString(16)).substr(n.length-2,2);return o};const W=function(e){e+="";var t,o,n,s,i,r,a,c,d,u=Array();for(e=function(e){e=e.replace(/\x0d\x0a/g,"\n");for(var t="",o=0;o<e.length;o++){var n=e.charCodeAt(o);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t}(e),u=function(e){for(var t,o=e.length,n=o+8,s=16*((n-n%64)/64+1),i=Array(s-1),r=0,a=0;a<o;)r=a%4*8,i[t=(a-a%4)/4]=i[t]|e.charCodeAt(a)<<r,a++;return r=a%4*8,i[t=(a-a%4)/4]=i[t]|128<<r,i[s-2]=o<<3,i[s-1]=o>>>29,i}(e),r=1732584193,a=4023233417,c=2562383102,d=271733878,t=0;t<u.length;t+=16)o=r,n=a,s=c,i=d,r=K(r,a,c,d,u[t+0],7,3614090360),d=K(d,r,a,c,u[t+1],12,3905402710),c=K(c,d,r,a,u[t+2],17,606105819),a=K(a,c,d,r,u[t+3],22,3250441966),r=K(r,a,c,d,u[t+4],7,4118548399),d=K(d,r,a,c,u[t+5],12,1200080426),c=K(c,d,r,a,u[t+6],17,2821735955),a=K(a,c,d,r,u[t+7],22,4249261313),r=K(r,a,c,d,u[t+8],7,1770035416),d=K(d,r,a,c,u[t+9],12,2336552879),c=K(c,d,r,a,u[t+10],17,4294925233),a=K(a,c,d,r,u[t+11],22,2304563134),r=K(r,a,c,d,u[t+12],7,1804603682),d=K(d,r,a,c,u[t+13],12,4254626195),c=K(c,d,r,a,u[t+14],17,2792965006),a=K(a,c,d,r,u[t+15],22,1236535329),r=F(r,a,c,d,u[t+1],5,4129170786),d=F(d,r,a,c,u[t+6],9,3225465664),c=F(c,d,r,a,u[t+11],14,643717713),a=F(a,c,d,r,u[t+0],20,3921069994),r=F(r,a,c,d,u[t+5],5,3593408605),d=F(d,r,a,c,u[t+10],9,38016083),c=F(c,d,r,a,u[t+15],14,3634488961),a=F(a,c,d,r,u[t+4],20,3889429448),r=F(r,a,c,d,u[t+9],5,568446438),d=F(d,r,a,c,u[t+14],9,3275163606),c=F(c,d,r,a,u[t+3],14,4107603335),a=F(a,c,d,r,u[t+8],20,1163531501),r=F(r,a,c,d,u[t+13],5,2850285829),d=F(d,r,a,c,u[t+2],9,4243563512),c=F(c,d,r,a,u[t+7],14,1735328473),a=F(a,c,d,r,u[t+12],20,2368359562),r=j(r,a,c,d,u[t+5],4,4294588738),d=j(d,r,a,c,u[t+8],11,2272392833),c=j(c,d,r,a,u[t+11],16,1839030562),a=j(a,c,d,r,u[t+14],23,4259657740),r=j(r,a,c,d,u[t+1],4,2763975236),d=j(d,r,a,c,u[t+4],11,1272893353),c=j(c,d,r,a,u[t+7],16,4139469664),a=j(a,c,d,r,u[t+10],23,3200236656),r=j(r,a,c,d,u[t+13],4,681279174),d=j(d,r,a,c,u[t+0],11,3936430074),c=j(c,d,r,a,u[t+3],16,3572445317),a=j(a,c,d,r,u[t+6],23,76029189),r=j(r,a,c,d,u[t+9],4,3654602809),d=j(d,r,a,c,u[t+12],11,3873151461),c=j(c,d,r,a,u[t+15],16,530742520),a=j(a,c,d,r,u[t+2],23,3299628645),r=q(r,a,c,d,u[t+0],6,4096336452),d=q(d,r,a,c,u[t+7],10,1126891415),c=q(c,d,r,a,u[t+14],15,2878612391),a=q(a,c,d,r,u[t+5],21,4237533241),r=q(r,a,c,d,u[t+12],6,1700485571),d=q(d,r,a,c,u[t+3],10,2399980690),c=q(c,d,r,a,u[t+10],15,4293915773),a=q(a,c,d,r,u[t+1],21,2240044497),r=q(r,a,c,d,u[t+8],6,1873313359),d=q(d,r,a,c,u[t+15],10,4264355552),c=q(c,d,r,a,u[t+6],15,2734768916),a=q(a,c,d,r,u[t+13],21,1309151649),r=q(r,a,c,d,u[t+4],6,4149444226),d=q(d,r,a,c,u[t+11],10,3174756917),c=q(c,d,r,a,u[t+2],15,718787259),a=q(a,c,d,r,u[t+9],21,3951481745),r=$(r,o),a=$(a,n),c=$(c,s),d=$(d,i);return(z(r)+z(a)+z(c)+z(d)).toLowerCase()};var J,X,Q,Z,ee,te=te||function(e,t){var o={},n=o.lib={},s=function(){},i=n.Base={extend:function(e){s.prototype=this;var t=new s;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},r=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,o=e.words,n=this.sigBytes;if(e=e.sigBytes,this.clamp(),n%4)for(var s=0;s<e;s++)t[n+s>>>2]|=(o[s>>>2]>>>24-s%4*8&255)<<24-(n+s)%4*8;else if(65535<o.length)for(s=0;s<e;s+=4)t[n+s>>>2]=o[s>>>2];else t.push.apply(t,o);return this.sigBytes+=e,this},clamp:function(){var t=this.words,o=this.sigBytes;t[o>>>2]&=4294967295<<32-o%4*8,t.length=e.ceil(o/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var o=[],n=0;n<t;n+=4)o.push(4294967296*e.random()|0);return new r.init(o,t)}}),a=o.enc={},c=a.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var o=[],n=0;n<e;n++){var s=t[n>>>2]>>>24-n%4*8&255;o.push((s>>>4).toString(16)),o.push((15&s).toString(16))}return o.join("")},parse:function(e){for(var t=e.length,o=[],n=0;n<t;n+=2)o[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new r.init(o,t/2)}},d=a.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var o=[],n=0;n<e;n++)o.push(String.fromCharCode(t[n>>>2]>>>24-n%4*8&255));return o.join("")},parse:function(e){for(var t=e.length,o=[],n=0;n<t;n++)o[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new r.init(o,t)}},u=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},l=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new r.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var o=this._data,n=o.words,s=o.sigBytes,i=this.blockSize,a=s/(4*i);if(t=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*i,s=e.min(4*t,s),t){for(var c=0;c<t;c+=i)this._doProcessBlock(n,c);c=n.splice(0,t),o.sigBytes-=s}return new r.init(c,s)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=l.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,o){return new e.init(o).finalize(t)}},_createHmacHelper:function(e){return function(t,o){return new g.HMAC.init(e,o).finalize(t)}}});var g=o.algo={};return o}(Math);X=(ee=(J=te).lib).WordArray,Q=ee.Hasher,Z=[],ee=J.algo.SHA1=Q.extend({_doReset:function(){this._hash=new X.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var o=this._hash.words,n=o[0],s=o[1],i=o[2],r=o[3],a=o[4],c=0;80>c;c++){if(16>c)Z[c]=0|e[t+c];else{var d=Z[c-3]^Z[c-8]^Z[c-14]^Z[c-16];Z[c]=d<<1|d>>>31}d=(n<<5|n>>>27)+a+Z[c],d=20>c?d+(1518500249+(s&i|~s&r)):40>c?d+(1859775393+(s^i^r)):60>c?d+((s&i|s&r|i&r)-1894007588):d+((s^i^r)-899497514),a=r,r=i,i=s<<30|s>>>2,s=n,n=d}o[0]=o[0]+n|0,o[1]=o[1]+s|0,o[2]=o[2]+i|0,o[3]=o[3]+r|0,o[4]=o[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,o=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(o/4294967296),t[15+(n+64>>>9<<4)]=o,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=Q.clone.call(this);return e._hash=this._hash.clone(),e}}),J.SHA1=Q._createHelper(ee),J.HmacSHA1=Q._createHmacHelper(ee),function(){var e=te,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,o){e=this._hasher=new e.init,"string"==typeof o&&(o=t.parse(o));var n=e.blockSize,s=4*n;o.sigBytes>s&&(o=e.finalize(o)),o.clamp();for(var i=this._oKey=o.clone(),r=this._iKey=o.clone(),a=i.words,c=r.words,d=0;d<n;d++)a[d]^=1549556828,c[d]^=909522486;i.sigBytes=r.sigBytes=s,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}();const oe=te;let ne="/user/info",se="/user/update",ie="/user/black/list",re="/user/black/add",ae="/user/black/remove",ce="/group/create",de="/group/edit",ue="/group/dissolve",le="/group/get",ge="/group/list",fe="/group/transferLeader",pe="/group/user/add",he="/group/user/leave",me="/group/user/delete",ye="/group/user/list",Ie="/group/user/set/adminstrator",ve="/group/user/apply/list",Te="/group/user/apply/change",Pe="/group/user/set/mute",Se="/conversation/list",Ee="/conversation/update/unread",be="/conversation/delete",ke="/message/save",_e="/v117/message/list",Ue="/message/delete",Ae="/message/revoke",Ce="/user/bind/push/id",Oe="/upload/sign",Le="/upload",Ne="/upload/image",Me="/upload/video";function xe(e,t="GET",o=null){return new Promise(((s,a)=>{uni.request({url:Mt.defaults.baseURL+e,data:o,method:t,header:{"content-type":"application/json",token:null!=Mt.token?Mt.token:""},success:e=>{if(null==e.data)return a({code:i,message:e.message?e.message:r,data:null});(e=e.data).code===n?s(e.data?e.data:null):a(e)},fail:e=>{Y(1,e),a({code:i,message:JSON.stringify(e),data:null})}})}))}function Ge(e){return uni.uploadFile({url:e.url,name:e.name,formData:e.data,header:e.header,filePath:e.filePath,success:t=>{if(e.ignoreResult)R(e,s);else{null==t.data&&reject(null);let o=(t=JSON.parse(t.data)).code;o===n?R(e,s,t.data?t.data:null):w(e,o,t.message)}},fail:t=>{Y(1,t),w(e,i,t)}})}async function Re(){let e=await xe(Oe,"GET",{});e.code?Y(1,"媒体上传参数获取失败",!0):Mt.mediaUploadParams=e}function we(){let e=Mt.defaults.baseURL;return"cos"==Mt.mediaUploadParams.storage?e=`https://${Mt.mediaUploadParams.bucket}.cos.${Mt.mediaUploadParams.region}.myqcloud.com`:"oss"==Mt.mediaUploadParams.storage&&(e=`https://${Mt.mediaUploadParams.bucket}.${Mt.mediaUploadParams.region}.aliyuncs.com`),e}function De(){return Mt.mediaUploadParams.customDomain?Mt.mediaUploadParams.customDomain:we()}function He(e,t="files"){let o=e;if(!Mt.mediaUploadParams.baseDir&&"local"===!Mt.mediaUploadParams.storage)return o;{let n=Mt.mediaUploadParams.baseDir,s=new Date,i=t+"/"+s.getFullYear()+"-"+JSON.stringify(s.getMonth()+1).padStart(2,0)+"-"+JSON.stringify(s.getDate()).padStart(2,0)+"/"+e;if("local"!==Mt.mediaUploadParams.storage){if("/"==n.substring(0,1)&&(n=n.substring(1)),"/"===n.substring(n.length-1,n.length)&&(n=n.substring(0,n.length)+n.substring(n.length+1)),!n)return i;o=n+"/"+i}else o=i}return o}async function Ve(e,t,o){let n=parseInt((new Date).getTime()/1e3)-1;(!Mt.mediaUploadParams||n>Mt.mediaUploadParams.expireTime)&&await Re();let s=Mt.mediaUploadParams.nowTime,i=Mt.mediaUploadParams.expireTime,r="sha1",a=Mt.mediaUploadParams.secretId,c=s+";"+i,d=s+";"+i,u=Mt.mediaUploadParams.signKey,l=e+"\n"+t+"\n\n"+o+"\n",g=r+"\n"+d+"\n"+oe.SHA1(l)+"\n";return`q-sign-algorithm=${r}&q-ak=${a}&q-sign-time=${c}&q-key-time=${d}&q-header-list=&q-url-param-list=&q-signature=${oe.HmacSHA1(g,u)}`}async function Ye(){let e=parseInt((new Date).getTime()/1e3)-1;return(!Mt.mediaUploadParams||e>Mt.mediaUploadParams.expireTime)&&await Re(),Mt.mediaUploadParams}function Be(e){if(!Mt.checkLogged())return w(e,g,f);if(!Mt.mediaUploadParams)return w(e,m,"上传参数异常，暂无法使用此接口");let t=Mt.mediaUploadParams,o=e.filename.substring(e.filename.lastIndexOf(".")),n=W((new Date).getTime()+"_"+e.filename)+"_other"+o,i=we(),r=De()+"/"+He(n);if("cos"===t.storage)setTimeout((async()=>{let t=await Ve("post","/",""),o=Ge({url:i,name:"file",data:{key:He(n),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,ignoreResult:!0,success:()=>{R(e,s,{url:r})},fail:()=>{w(e,A,C)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"===t.storage)setTimeout((async()=>{await Ye();let o=Ge({url:i,name:"file",data:{key:He(n),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,ignoreResult:!0,success:()=>{R(e,s,{url:r})},fail:()=>{w(e,N,M)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"===t.storage){let t=Ge({url:i+Le,name:"file",data:{key:He(n)},header:{token:Mt.token},filePath:e.filepath,ignoreResult:!1,success:t=>{R(e,s,{url:De()+t.url})},fail:()=>{w(e,k,_)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}function $e(e){if(!Mt.mediaUploadParams)return w(e,m,"上传参数异常，暂无法使用此接口");let t=Mt.mediaUploadParams,o=e.filename.substring(e.filename.lastIndexOf(".")),n=W((new Date).getTime()+"_"+e.filename)+"_image"+o,i=we(),r=De()+"/"+He(n,"image");if("cos"===t.storage)setTimeout((async()=>{let t=await Ve("post","/",""),o=Ge({url:i,name:"file",data:{key:He(n,"image"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,ignoreResult:!0,success:()=>{let t=0,o=0;if(e.height>198){let n=198/e.height;t=parseInt(e.height*n),o=parseInt(e.width*n)}else if(e.width>198){let n=198/e.width;t=parseInt(e.height*n),o=parseInt(e.width*n)}R(e,s,{url:r,thumbnailUrl:r+"?imageMogr2/thumbnail/"+o+"x"+t,thumbnailWidth:o,thumbnailHeight:t})},fail:()=>{w(e,A,C)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"===t.storage)setTimeout((async()=>{await Ye();let o=Ge({url:i,name:"file",data:{key:He(n,"image"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,ignoreResult:!0,success:()=>{let t=0,o=0;if(e.height>198){let n=198/e.height;t=parseInt(e.height*n),o=parseInt(e.width*n)}else if(e.width>198){let n=198/e.width;t=parseInt(e.height*n),o=parseInt(e.width*n)}R(e,s,{url:r,thumbnailUrl:r+"?x-oss-process=image/resize,m_fixed,h_"+t+",w_"+o,thumbnailWidth:o,thumbnailHeight:t})},fail:()=>{w(e,N,M)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"===t.storage){let t=Ge({url:i+Ne,name:"file",data:{key:He(n)},header:{token:Mt.token},filePath:e.filepath,ignoreResult:!1,success:t=>{R(e,s,{url:De()+t.url,thumbnailUrl:De()+t.thumbnailUrl,thumbnailWidth:t.thumbnailWidth,thumbnailHeight:t.thumbnailHeight})},fail:()=>{w(e,k,_)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}const Ke=function(e){return{conversationId:e.to,conversationType:e.conversationType,fromUserInfo:{nickname:Mt.user.nickname,avatarUrl:Mt.user.avatarUrl},from:Mt.userId,to:e.to,type:e.type,isRead:0,isRevoke:0,isDeleted:0,status:"unSend",time:(new Date).getTime(),body:e.body,extra:e.extra?e.extra:""}};function Fe(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body||!e.body.text)return G(m,"text 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.TEXT,conversationType:e.conversationType,body:{text:e.body.text}};return e.extra&&(t.extra=e.extra),Ke(t)}function je(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body||!e.body.file)return G(m,"file 不能为空");if(!e.body.file.tempFilePath)return G(m,"tempFilePath 不能为空");if(!e.body.file.width)return G(m,"width 不能为空");if(!e.body.file.height)return G(m,"height 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.IMAGE,conversationType:e.conversationType,body:{originalUrl:e.body.file.tempFilePath,originalWidth:e.body.file.width,originalHeight:e.body.file.height,thumbnailUrl:e.body.file.tempFilePath,thumbnailWidth:e.body.file.width,thumbnailHeight:e.body.file.height}};e.extra&&(t.extra=e.extra);let n=Ke(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(n.onProgress=e.onProgress),n}function qe(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body.address)return G(m,"address 不能为空");if(!e.body.description)return G(m,"description 不能为空");if(!e.body.longitude)return G(m,"longitude 不能为空");if(!e.body.latitude)return G(m,"latitude 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.LOCATION,conversationType:e.conversationType,body:{address:e.body.address,description:e.body.description,longitude:e.body.longitude,latitude:e.body.latitude}};return e.extra&&(t.extra=e.extra),Ke(t)}function ze(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body||!e.body.file)return G(m,"file 不能为空");if(!e.body.file.tempFilePath)return G(m,"tempFilePath 不能为空");if(!e.body.file.duration)return G(m,"duration 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.AUDIO,conversationType:e.conversationType,body:{audioUrl:e.body.file.tempFilePath,duration:e.body.file.duration}};e.extra&&(t.extra=e.extra);let n=Ke(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(n.onProgress=e.onProgress),n}function We(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body||!e.body.file)return G(m,"file 不能为空");if(!e.body.file.duration)return G(m,"duration 不能为空");if("number"!=typeof e.body.file.duration)return G(m,"duration 参数请传入整型");if(!e.body.file.tempFilePath)return G(m,"tempFilePath 不能为空");if(!e.body.file.width)return G(m,"width 不能为空");if(!e.body.file.height)return G(m,"height 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.VIDEO,conversationType:e.conversationType,body:{videoUrl:e.body.file.tempFilePath,thumbnailUrl:"",duration:e.body.file.duration,videoWidth:e.body.file.width,videoHeight:e.body.file.height}};e.extra&&(t.extra=e.extra);let n=Ke(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(n.onProgress=e.onProgress),n}function Je(e){if(!Mt.checkLogged())return G(g,f);if(null==e||!e.toId)return G(m,"toId 不能为空");if(!e.conversationType)return G(m,"conversationType 不能为空");if(!e.body)return G(m,"自定义消息的 body 不能为空");let t={to:e.toId,type:o.MESSAGE_TYPE.CUSTOM,conversationType:e.conversationType,body:e.body};return e.extra&&(t.extra=e.extra),Ke(t)}function Xe(e){if(!Mt.checkLogged())return w(e,g,f);if(!e.message)return w(e,m,"message 不能为空");let t=e.message;t.type==o.MESSAGE_TYPE.TEXT?Qe(e):t.type==o.MESSAGE_TYPE.IMAGE?function(e){let t=e.message;$e({filename:Mt.token+"_image.png",filepath:t.body.originalUrl,width:t.body.originalWidth,height:t.body.originalHeight,success:o=>{t.body.originalUrl=o.data.url,t.body.thumbnailWidth=o.data.thumbnailWidth,t.body.thumbnailHeight=o.data.thumbnailHeight,t.body.thumbnailUrl=o.data.thumbnailUrl,e.message=t,Qe(e)},fail:t=>{w(e,t.code,t.message),Y(1,t)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==o.MESSAGE_TYPE.VIDEO?function(e){let t=e.message;!function(e){if(!Mt.mediaUploadParams)return Y(1,"媒体上传参数获取失败",!0);let t=Mt.mediaUploadParams,o=e.filename.substring(e.filename.lastIndexOf(".")),n=W((new Date).getTime()+"_"+e.filename)+"_video"+o,r=we(),a=De()+"/"+He(n,"video");if("cos"==t.storage)setTimeout((async()=>{let t=await Ve("post","/",""),o=Ge({url:r,name:"file",data:{key:He(n,"video"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,ignoreResult:!0,success:async()=>{let t=await Ve("get","/"+He(n,"video"),"");!function(e){uni.downloadFile({url:e.url,header:e.header,success:t=>{200===t.statusCode?R(e,s,t.tempFilePath):w(e,U,U.describe)},fail:t=>{Y(1,t),w(e,U,U.describe)}})}({url:r+"/"+He(n,"video")+"?ci-process=snapshot&time=1",header:{Authorization:t},success:t=>{$e({filename:W(n+t.data)+"_videoThumb.jpg",filepath:t.data,success:t=>{R(e,s,{videoUrl:a,thumbnailUrl:t.data.url})},fail:t=>{w(e,i,t)}})},fail:()=>{w(e,O,L)}})},fail:()=>{w(e,A,C)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"===t.storage)setTimeout((async()=>{await Ye();let o=Ge({url:r,name:"file",data:{key:He(n,"video"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,ignoreResult:!0,success:()=>{R(e,s,{videoUrl:a,thumbnailUrl:a+"?x-oss-process=video/snapshot,t_1000,f_jpg,m_fast"})},fail:()=>{w(e,N,M)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"===t.storage){let t=Ge({url:r+Me,name:"file",data:{key:He(n,"video")},header:{token:Mt.token},filePath:e.filepath,ignoreResult:!1,success:t=>{R(e,s,{url:De()+t.url})},fail:()=>{w(e,k,_)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}({filename:Mt.token+"_video.mp4",filepath:t.body.videoUrl,success:o=>{let n=o.data.videoUrl,s=o.data.thumbnailUrl;t.body.videoUrl=n,t.body.thumbnailUrl=s,e.message=t,Qe(e)},fail:t=>{w(e,t.code,t.message),Y(1,t)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==o.MESSAGE_TYPE.AUDIO?function(e){let t=e.message;!function(e){if(!Mt.mediaUploadParams)return w(e,m,"上传参数异常，暂无法使用此接口");let t=Mt.mediaUploadParams,o=e.filename.substring(e.filename.lastIndexOf(".")),n=W((new Date).getTime()+"_"+e.filename)+"_audio"+o,i=we(),r=De()+"/"+He(n,"audio");if("cos"===t.storage)setTimeout((async()=>{let t=await Ve("post","/",""),o=Ge({url:i,name:"file",data:{key:He(n,"audio"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,ignoreResult:!0,success:()=>{R(e,s,{url:r})},fail:()=>{w(e,A,C)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"===t.storage)setTimeout((async()=>{await Ye();let o=Ge({url:i,name:"file",data:{key:He(n,"audio"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,ignoreResult:!0,success:()=>{R(e,s,{url:r})},fail:()=>{w(e,N,M)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&o.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"===t.storage){let t=Ge({url:i+"/upload",name:"file",data:{key:He(n,"audio")},header:{token:Mt.token},filePath:e.filepath,ignoreResult:!1,success:t=>{R(e,s,{url:De()+t.url})},fail:()=>{w(e,k,_)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}({filename:Mt.token+"_audio.aac",filepath:t.body.audioUrl,success:o=>{let n=o.data.url;t.body.audioUrl=n,e.message=t,Qe(e)},fail:t=>{w(e,t.code,t.message),Y(1,t)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==o.MESSAGE_TYPE.LOCATION&&Qe(e)}function Qe(e){let t=e.message;xe(ke,"POST",t).then((t=>{Ze(t),R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)}))}function Ze(e){if(!e.conversationId)return Y(1,"conversationId 不能为空");let t=nt(e.conversationId),o=t.findIndex((t=>t.messageId===e.messageId)),n=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e.conversationId)}`;-1===o?(t.length>19&&t.splice(0,t.length-19),t.push(e),uni.setStorageSync(n,t)):(t[o]=e,uni.setStorageSync(n,t))}function et(e){if(!Mt.checkLogged())return w(e,g,f);if(!e.conversationId)return w(e,m,"conversationId 不能为空");let t=20;if(e.limit&&"number"==typeof e.limit&&(t=e.limit),e.nextMessageId){let o=e.nextMessageId,n=nt(e.conversationId),i=n.findIndex((e=>e.messageId===o));if(-1===i)tt(e.conversationId,o,t).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message)}));else{let o=n[i];if(n=n.slice(0,i),n.length<t){let i=t-n.length,r=null;r=0==n.length?o.messageId:n[0].messageId,tt(e.conversationId,r,i).then((t=>{let o=t.list,i=n.concat(o);i.sort(((e,t)=>e.sequence-t.sequence)),t.list=i,t.nextMessageId||(t.nextMessageId=r),R(e,s,t)})).catch((t=>{w(e,t.code,t.message)}))}else R(e,s,{list:n,nextMessageId:n[0].messageId})}}else{let o=nt(e.conversationId);if(o.length<t){let n=t-o.length,i=null;o.length>0&&(i=o[0].messageId),tt(e.conversationId,i,n).then((t=>{let n=t.list,r=o.concat(n);r.sort(((e,t)=>e.sequence-t.sequence));let a=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e.conversationId)}`;uni.setStorageSync(a,r),t.list=r,t.nextMessageId||(t.nextMessageId=i),R(e,s,t)})).catch((t=>{w(e,t.code,t.message)}))}else R(e,s,{list:o,nextMessageId:o[0].messageId})}}function tt(e,t=null,o=20){return new Promise(((o,n)=>{xe(_e,"GET",{nextMessageId:null==t||""==t?null:t,conversationId:e}).then((e=>{let t={},n=e.records;n=n.reverse(),n.sort(((e,t)=>e.sequence-t.sequence)),t.list=n,e.nextMessageId&&(t.nextMessageId=e.nextMessageId),o(t)})).catch((e=>{n(e)}))}))}function ot(e){if(Y(1,"从1.1.7版本开始不再推荐使用[getMessageList]获取历史消息记录，请使用[getHistoryMessageList]",!0),!Mt.checkLogged())return w(e,g,f);if(!e.conversationId)return w(e,m,"conversationId 不能为空");if(e.page&&parseFloat(e.page)||(e.page=1),1!=e.page)return st(e,e.page);let t=nt(e.conversationId);if(t.length<=0)st(e,e.page);else{let o="yeim:conversationList:"+W(Mt.userId),n=uni.getStorageSync(o);if(n=n||[],n<=0)return w(e,i,"会话不存在");{let o=n.findIndex((t=>t.conversationId===e.conversationId));if(-1===o)return w(e,i,"会话不存在");if(n[o].lastMessage.messageId==t[t.length-1].messageId)return R(e,s,t);st(e,e.page)}}}function nt(e){let t=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e)}`,o=uni.getStorageSync(t);return o=o||[],o.sort(((e,t)=>e.sequence-t.sequence)),o}function st(e,t=1){uni.request({url:Mt.defaults.baseURL+"/message/list",data:{page:t,conversationId:e.conversationId},method:"GET",header:{"content-type":"application/json",token:Mt.token},success:o=>{if(200==o.data.code){let n=o.data.data.records;if(n=n.reverse(),n.sort(((e,t)=>e.sequence-t.sequence)),R(e,s,n),1==t){let t="yeim:messageList:"+W(Mt.userId)+":conversationId:"+W(e.conversationId);uni.setStorageSync(t,n)}}else w(e,o.data.code,o.data.message)},fail:t=>{w(e,i,t),Y(1,t)}})}function it(e){return Mt.checkLogged()?e.message?e.message.messageId?void xe(Ue,"GET",{messageId:e.message.messageId}).then((()=>{e.message.isDeleted=1,Ze(e.message),R(e,s,e.message)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"message.messageId 不能为空"):w(e,m,"message 不能为空"):w(e,g,f)}function rt(e){return Mt.checkLogged()?e.message?e.message.messageId?void xe(Ae,"GET",{messageId:e.message.messageId}).then((()=>{e.message.isRevoke=1,Ze(e.message),R(e,s,e.message)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"message.messageId 不能为空"):w(e,m,"message 不能为空"):w(e,g,f)}function at(e){if(!Mt.checkLogged())return G(g,f);if(!e)return G(m,"conversationId 不能为空");let t=`yeim:conversationList:${W(Mt.userId)}`,o=uni.getStorageSync(t);o=o||[];let n=o.findIndex((t=>t.conversationId===e));return-1!==n?x(s,o[n]):G(p,h)}function ct(e){if(!Mt.checkLogged())return w(e,g,f);let t=e.page,o=e.limit,n=`yeim:conversationList:${W(Mt.userId)}`,i=uni.getStorageSync(n);i=i||[];let r=(t-1)*o,a=r+o>=i.length?i.slice(r,i.length):i.slice(r,r+o);R(e,s,a)}function dt(){xe(Se,"GET",{page:1,limit:999999}).then((e=>{ut(e.records)})).catch((e=>{w(options,e.code,e.message),Y(1,e)}))}function ut(e){let t=`yeim:conversationList:${W(Mt.userId)}`;uni.setStorageSync(t,e),D(o.EVENT.CONVERSATION_LIST_CHANGED,e)}function lt(e){if(!Mt.checkLogged())return G(g,f);let t=`yeim:conversationList:${W(Mt.userId)}`,n=uni.getStorageSync(t);n=n||[];let s=n.findIndex((t=>t.conversationId===e));-1!==s&&(n[s].unread=0,uni.setStorageSync(t,n)),xe(Ee,"GET",{conversationId:e}).then((()=>{})).catch((e=>{Y(1,e)})),D(o.EVENT.CONVERSATION_LIST_CHANGED,n)}function gt(e){if(!Mt.checkLogged())return G(g,f);let t=`yeim:conversationList:${W(Mt.userId)}`,n=uni.getStorageSync(t);n=n||[];let s=n.findIndex((t=>t.conversationId===e));-1!==s&&(n.splice(s,1),uni.setStorageSync(t,n));let i=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e)}`;uni.removeStorageSync(i),xe(be,"GET",{conversationId:e}).then((()=>{})).catch((e=>{Y(1,e)})),D(o.EVENT.CONVERSATION_LIST_CHANGED,n)}function ft(e){return Mt.checkLogged()?e.name?e.avatarUrl?void xe(ce,"POST",e).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"avatarUrl 不能为空"):w(e,m,"name 不能为空"):w(e,g,f)}function pt(e){return Mt.checkLogged()?e.groupId?void xe(ue,"GET",{groupId:e.groupId}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function ht(e){return Mt.checkLogged()?e.groupId?e.userId?void xe(fe,"GET",{groupId:e.groupId,userId:e.userId}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"userId 不能为空"):w(e,m,"groupId 不能为空"):w(e,g,f)}function mt(e){return Mt.checkLogged()?e.groupId?void xe(de,"POST",e).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function yt(e){return Mt.checkLogged()?e.groupId?void xe(le,"GET",{groupId:e.groupId}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function It(e){if(!Mt.checkLogged())return w(e,g,f);xe(ge,"GET",{}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)}))}function vt(e){return Mt.checkLogged()?e.groupId?void xe(pe,"POST",{groupId:e.groupId,members:[Mt.userId]}).then((t=>{let s=t.group,a=t.successList;if(-1!=t.ignoreList.indexOf(Mt.userId))return w(e,v,T);let c=!1;if(-1!=a.indexOf(Mt.userId)&&(c=!0),!c)return w(e,P,S);if(s.joinMode==o.GROUP.JOINMODE.FREE)R(e,n,"成功加入群组");else{if(s.joinMode!=o.GROUP.JOINMODE.CHECK)return w(e,i,r);R(e,E,b)}})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function Tt(e){return Mt.checkLogged()?e.groupId?void xe(he,"GET",{groupId:e.groupId}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function Pt(e){return Mt.checkLogged()?e.groupId?!e.members||e.members.length<=0?w(e,m,"members 不能为空"):void xe(pe,"POST",{groupId:e.groupId,members:e.members}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function St(e){return Mt.checkLogged()?e.groupId?!e.members||e.members.length<=0?w(e,m,"members 不能为空"):void xe(me,"POST",{groupId:e.groupId,members:e.members}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function Et(e){return Mt.checkLogged()?e.groupId?void xe(ye,"GET",{groupId:e.groupId}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function bt(e){return Mt.checkLogged()?e.groupId?void xe(Ie,"GET",{groupId:e.groupId,userId:e.userId,isAdmin:1===isAdmin?isAdmin:0}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function kt(e){return Mt.checkLogged()?e.groupId?void xe(ve,"GET",{}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"groupId 不能为空"):w(e,g,f)}function _t(e){return Mt.checkLogged()?e.id?e.status?void xe(Te,"GET",{id:e.id,status:e.status}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)})):w(e,m,"status 不能为空"):w(e,m,"id 不能为空"):w(e,g,f)}function Ut(e){return Mt.checkLogged()?e.groupId?e.userId?(e.time||(e.time=0),void xe(Pe,"GET",{groupId:e.groupId,userId:e.userId,time:e.time}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),Y(1,t)}))):w(e,m,"userId 不能为空"):w(e,m,"groupId 不能为空"):w(e,g,f)}function At(e){return Mt.checkLogged()?e.userId?void xe(ne,"GET",{userId:e.userId}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),log(1,t)})):w(e,m,"userId 不能为空"):w(e,g,f)}function Ct(e){return Mt.checkLogged()?e.nickname?e.avatarUrl?void xe(se,"POST",{nickname:e.nickname,avatarUrl:e.avatarUrl}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),log(1,t)})):w(e,m,"avatarUrl 不能为空"):w(e,m,"nickname 不能为空"):w(e,g,f)}function Ot(e){if(!Mt.checkLogged())return w(e,g,f);xe(ie,"GET",{}).then((t=>{R(e,s,t)})).catch((t=>{w(e,t.code,t.message),log(1,t)}))}function Lt(e){return Mt.checkLogged()?e.members&&0!=e.members.length?void xe(re,"POST",{members:e.members}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),log(1,t)})):w(e,m,"members 不能为空"):w(e,g,f)}function Nt(e){return Mt.checkLogged()?e.members&&0!=e.members.length?void xe(ae,"POST",{members:e.members}).then((()=>{R(e,s)})).catch((t=>{w(e,t.code,t.message),log(1,t)})):w(e,m,"members 不能为空"):w(e,g,f)}let Mt;class xt{constructor(e={}){this.defaults={baseURL:void 0,socketURL:void 0,eventPrefix:"YeIM_",reConnectTotal:15,reConnectInterval:3e3,heartInterval:3e4,logLevel:0,...e,notification:{autoPermission:!1,oppoChannelId:"Default",xiaomiChannelId:"high_system",...e.notification}},this.version="1.1.9",this.systemInfo=uni.getSystemInfoSync(),this.firstConnect=!0,this.socketTask=void 0,this.socketLogged=!1,this.allowReconnect=!0,this.lockReconnect=!1,this.reConnectNum=0,this.connectTimer=void 0,this.heartTimer=void 0,this.checkTimer=void 0,this.user={},this.userId=void 0,this.token=void 0,this.mediaUploadParams={},this.mobileDeviceId=void 0,this.inApp=!0}static init(e={}){return Mt||(e.baseURL&&e.socketURL?(Mt=new xt(e),xt.prototype.createTextMessage=Fe,xt.prototype.createImageMessage=je,xt.prototype.createAudioMessage=ze,xt.prototype.createVideoMessage=We,xt.prototype.createLocationMessage=qe,xt.prototype.createCustomMessage=Je,xt.prototype.upload=Be,xt.prototype.sendMessage=Xe,xt.prototype.getMessageList=ot,xt.prototype.getHistoryMessageList=et,xt.prototype.revokeMessage=rt,xt.prototype.deleteMessage=it,xt.prototype.getConversation=at,xt.prototype.getConversationList=ct,xt.prototype.clearConversationUnread=lt,xt.prototype.deleteConversation=gt,xt.prototype.getUserInfo=At,xt.prototype.updateUserInfo=Ct,xt.prototype.getBlackUserList=Ot,xt.prototype.addToBlackUserList=Lt,xt.prototype.removeFromBlacklist=Nt,xt.prototype.addEventListener=H,xt.prototype.removeEventListener=V,xt.prototype.createGroup=ft,xt.prototype.dissolveGroup=pt,xt.prototype.updateGroup=mt,xt.prototype.getGroup=yt,xt.prototype.transferLeader=ht,xt.prototype.getGroupList=It,xt.prototype.joinGroup=vt,xt.prototype.leaveGroup=Tt,xt.prototype.addGroupUsers=Pt,xt.prototype.getGroupUserList=Et,xt.prototype.removeGroupUsers=St,xt.prototype.setAdminstrator=bt,xt.prototype.setMute=Ut,xt.prototype.getGroupApplyList=kt,xt.prototype.handleApply=_t,Y(1,"============= YeIMUniSDK 初始化成功！版本号："+Mt.version+" ============="),Mt):console.error(a))}static getInstance(){return Mt||null}connect(e={}){if(!e.userId||!e.token)return w(e,u,l);let t=this.defaults.socketURL+"/"+e.userId+"/"+e.token;this.socketTask=uni.connectSocket({url:t,success:()=>{},fail:()=>{},complete:()=>{}}),this.socketTask.onOpen(this.socketOpen.bind(this)),this.socketTask.onClose(this.socketClose.bind(this)),this.socketTask.onError(this.socketError.bind(this)),this.socketTask.onMessage(this.socketMessage.bind(this)),this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0),this.connectTimer=setTimeout((()=>(this.connectTimer=void 0,Y(1,"连接服务端失败，请检查配置"),w(e,c,d))),this.defaults.reConnectInterval+1e3),this.socketTask.onMessage((t=>{if(this.socketLogged)return clearTimeout(this.connectTimer),void(this.connectTimer=void 0);clearTimeout(this.connectTimer),this.connectTimer=void 0;let o=JSON.parse(t.data);if(201==o.code){let t=o.data.user;this.user=t,this.userId=e.userId,this.token=e.token;let n=o.data.pushConfig;n.oppoChannelId&&(this.defaults.notification.oppoChannelId=n.oppoChannelId),n.xiaomiChannelId&&(this.defaults.notification.xiaomiChannelId=n.xiaomiChannelId),this.socketLogged=!0,this.reConnectNum=0,Y(1,`YeIMServer登陆成功，登陆用户：${e.userId}`),dt(),Re(),this.defaults.notification.autoPermission&&function(){if("app"==Mt.systemInfo.uniPlatform&&"android"==Mt.systemInfo.osName){var e=plus.android.runtimeMainActivity(),t=e.getPackageName(),o=e.getApplicationInfo().plusGetAttribute("uid"),n=plus.android.importClass("android.support.v4.app.NotificationManagerCompat");null==n&&(n=plus.android.importClass("androidx.core.app.NotificationManagerCompat"));var s=n.from(e).areNotificationsEnabled(),i=uni.getStorageSync("first_flag")||!1;s||i||(uni.setStorageSync("first_flag",!0),uni.showModal({title:"通知权限开启提醒",content:"您还没有开启通知权限，无法接受到消息通知，请前往设置！",showCancel:!1,confirmText:"去设置",success:function(n){if(n.confirm){var s=plus.android.importClass("android.content.Intent"),i=plus.android.importClass("android.os.Build");if(i.VERSION.SDK_INT>=26)(r=new s("android.settings.APP_NOTIFICATION_SETTINGS")).putExtra("android.provider.extra.APP_PACKAGE",t);else if(i.VERSION.SDK_INT>=21){var r;(r=new s("android.settings.APP_NOTIFICATION_SETTINGS")).putExtra("app_package",t),r.putExtra("app_uid",o)}else{r.setAction(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);var a=Uri.fromParts("package",mainActivity.getPackageName(),null);r.setData(a)}e.startActivity(r)}}}))}else if("app"==Mt.systemInfo.uniPlatform&&"ios"==Mt.systemInfo.osName){var r=0,a=plus.ios.invoke("UIApplication","sharedApplication"),c=plus.ios.invoke(a,"currentUserNotificationSettings");c?(r=c.plusGetAttribute("types"),plus.ios.deleteObject(c)):r=plus.ios.invoke(a,"enabledRemoteNotificationTypes"),plus.ios.deleteObject(a),0==(0!=r)&&uni.showModal({title:"通知权限开启提醒",content:"您还没有开启通知权限，无法接受到消息通知，请前往设置！",showCancel:!1,confirmText:"去设置",success:function(e){if(e.confirm){var t=plus.ios.invoke("UIApplication","sharedApplication"),o=plus.ios.invoke("NSURL","URLWithString:","app-settings:");plus.ios.invoke(t,"openURL:",o),plus.ios.deleteObject(o),plus.ios.deleteObject(t)}}})}}(),function(){if("app"==Mt.systemInfo.uniPlatform&&"android"==Mt.systemInfo.osName&&Mt.defaults.notification&&Mt.defaults.notification.oppoChannelId&&plus.android.importClass("android.os.Build").VERSION.SDK_INT>=26){let e=Mt.defaults.notification.oppoChannelId,t="聊天离线通知",o=plus.android.runtimeMainActivity(),n=plus.android.importClass("android.content.Context"),s=plus.android.importClass("android.app.NotificationManager"),i=o.getSystemService(n.NOTIFICATION_SERVICE),r=i.getNotificationChannel(e),a=plus.android.importClass("android.app.NotificationChannel"),c=plus.android.importClass("android.app.Notification");if(r&&i.deleteNotificationChannel(r),!r||null==r||"null"==r||null==r){let o=new a(e,t,s.IMPORTANCE_HIGH);o.setDescription("用于用户离线时推送消息通知"),o.enableVibration(!0),o.enableLights(!0),o.setBypassDnd(!0),o.setLockscreenVisibility(c.VISIBILITY_SECRET),i.createNotificationChannel(o)}}}(),Mt.checkLogged()&&"app"==Mt.systemInfo.uniPlatform&&plus.push.getClientInfoAsync((e=>{let t=e.clientid;t&&xe(Ce,"GET",{clientId:t}).then((()=>{Y(0,"注册APP用户离线通知推送标识符成功，当前获取的cid为："+t)})).catch((e=>{Y(1,"注册APP用户离线通知推送标识符异常："+e.message)}))}));let i=[];return uni.onPushMessage((e=>{if(!this.inApp&&"receive"==e.type){let t=e.data.__UUID__;i.indexOf(t)<=0&&(i.push(t),uni.createPushMessage({title:e.data.title,content:e.data.content,sound:"system",success:()=>{},fail:()=>{}}))}})),R(e,s,t)}return w(e,y,I)}))}disConnect(){this.allowReconnect=!1,this.socketTask.close(),this.socketTask=void 0}reConnect(){if(this.allowReconnect&&!this.lockReconnect){if(!this.userId||!this.token)return void(this.allowReconnect=!1);if(this.defaults.reConnectTotal>0&&this.defaults.reConnectTotal<=this.reConnectNum)return void(this.allowReconnect=!1);this.reConnectNum++,this.lockReconnect=!0,D(o.EVENT.NET_CHANGED,"connecting"),setTimeout((()=>{Y(1,`WebSocket 正在进行第${this.reConnectNum}次重连`);try{this.connect({userId:this.userId,token:this.token})}catch(e){console.log(e)}this.lockReconnect=!1}),this.defaults.reConnectInterval)}}readyState(){return this.socketTask?this.socketTask.readyState:3}startHeartTimer(){this.clearHeartTimer(),this.socketTask&&(this.heartTimer=setTimeout((()=>{if(1==this.readyState()){let e={type:"heart",data:"ping"};this.socketTask.send({data:JSON.stringify(e)}),this.checkTimer=setTimeout((()=>{uni.closeSocket()}),this.defaults.heartInterval)}}),this.defaults.heartInterval))}clearHeartTimer(){return clearTimeout(this.heartTimer),clearTimeout(this.checkTimer),this}socketOpen(e){Y(1,"WebSocket成功连接"),D(o.EVENT.NET_CHANGED,"connected")}socketClose(e){Y(1,"WebSocket断开连接"),this.socketLogged=!1,this.socketTask=void 0,D(o.EVENT.NET_CHANGED,"closed"),this.reConnect()}socketError(e){Y(1,e),this.reConnect()}socketMessage(e){if(Y(0,e),this.startHeartTimer(),!this.socketLogged)return;let t=JSON.parse(e.data);t?this.socketMessageHandle(t):Y(1,e)}socketMessageHandle(e){if(200==e.code){let t=e.data;Ze(t),D(o.EVENT.MESSAGE_RECEIVED,t)}else 203==e.code?function(e){let t=`yeim:conversationList:${W(Mt.userId)}`,o=uni.getStorageSync(t);o=o||[];let n=o.findIndex((t=>t.conversationId===e.conversationId));-1===n||o.splice(n,1),o.unshift(e),ut(o)}(e.data):205==e.code?function(e){if(!e)return Y(1,"conversationId 为空，无法继续执行");let t=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e)}`,n=uni.getStorageSync(t);if(n=n||[],n){let s=[];for(let e=0;e<n.length;e++){let t=n[e];"out"==t.direction&&(t.isRead=1,n[e].isRead=1,s.push(t))}uni.setStorageSync(t,n),D(o.EVENT.PRIVATE_READ_RECEIPT,{conversationId:e,list:s})}}(e.data.conversationId):207==e.code?function(e){let t=`yeim:messageList:${W(Mt.userId)}:conversationId:${W(e.conversationId)}`,n=uni.getStorageSync(t)?uni.getStorageSync(t):[];n=n||[];let s=n.findIndex((t=>t.messageId===e.messageId));-1!==s&&(n[s]=e,uni.setStorageSync(t,n)),D(o.EVENT.MESSAGE_REVOKED,e)}(e.data):10009==e.code&&(this.allowReconnect=!1,this.clearHeartTimer(),uni.closeSocket(),D(o.EVENT.KICKED_OUT,!0),Y(1,`用户：${this.userId} 由于多个实例同时登录被踢出`))}checkLogged(){return!!(this.socketLogged&&this.userId&&this.token)}intoApp(){this.inApp=!0}leaveApp(){this.inApp=!1}}return t})()));
//# sourceMappingURL=yeim-uni-sdk.min.js.map